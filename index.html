<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidra Elite | Professional Node</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #efb94b; --gold-glow: rgba(239, 185, 75, 0.4); --bg: #050608; --card: rgba(18, 22, 30, 0.98); --border: rgba(255, 255, 255, 0.08); }
        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        body { background: radial-gradient(circle at top right, #1a1f2c, var(--bg)); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        #site-name { cursor: pointer; font-weight: 700; font-size: 11px; letter-spacing: 7px; color: var(--gold); margin-bottom: 25px; text-transform: uppercase; text-shadow: 0 0 10px var(--gold-glow); }
        .card { background: var(--card); backdrop-filter: blur(35px); border: 1px solid var(--border); border-radius: 40px; width: 420px; padding: 45px; box-shadow: 0 60px 120px rgba(0,0,0,0.9); position: relative; }
        .card::before { content: ""; position: absolute; inset: -1px; border-radius: 40px; padding: 1px; background: linear-gradient(135deg, var(--border), var(--gold), var(--border)); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; }
        .bal-val { font-size: 52px; font-weight: 700; text-align: center; margin: 10px 0 35px 0; background: linear-gradient(135deg, #fff 30%, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 30px; background: rgba(0,0,0,0.4); padding: 6px; border-radius: 20px; }
        .tab { flex: 1; padding: 14px; border-radius: 16px; border: none; background: none; color: #777; cursor: pointer; font-size: 11px; font-weight: 700; letter-spacing: 1px; }
        .tab.active { background: var(--gold); color: #000; box-shadow: 0 5px 15px var(--gold-glow); }
        
        .phrase-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 20px; border: 1px solid rgba(239, 185, 75, 0.2); }
        .word-chip { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); padding: 8px; border-radius: 10px; font-size: 12px; display: flex; align-items: center; }
        .word-num { color: var(--gold); font-weight: 700; margin-right: 8px; font-size: 10px; opacity: 0.7; }
        .word-text { color: #fff; font-weight: 500; letter-spacing: 0.5px; }

        .input-group { position: relative; margin-bottom: 20px; }
        input, textarea { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 18px; padding-right: 80px; color: white; border-radius: 20px; font-size: 14px; font-family: inherit; }
        input:focus, textarea:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 20px rgba(239,185,75,0.1); background: rgba(255,255,255,0.05); }
        .input-btn-group { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px; }
        .small-action-btn { background: var(--gold); color: #000; border: none; padding: 6px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; cursor: pointer; }

        .btn { background: var(--gold); color: #000; border: none; padding: 22px; width: 100%; border-radius: 22px; font-weight: 700; cursor: pointer; font-size: 15px; position: relative; overflow: hidden; margin-bottom: 10px; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 30px var(--gold-glow); filter: brightness(1.1); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        #toast { visibility: hidden; min-width: 280px; background-color: var(--gold); color: #000; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 6000; bottom: 30px; font-size: 13px; font-weight: 700; letter-spacing: 1px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        #admin-overlay, #pin-overlay, #receipt-overlay, #cs-overlay, #legal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 4000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
        .overlay-box { width: 90%; max-width: 420px; background: #0c0d10; border: 1px solid var(--border); padding: 40px; border-radius: 40px; max-height: 80vh; overflow-y: auto; }
        .hist-list { max-height: 250px; overflow-y: auto; }
        .hist-item { background: rgba(255,255,255,0.02); padding: 20px; border-radius: 22px; margin-bottom: 12px; border: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .dot { width: 16px; height: 16px; border: 2px solid var(--gold); border-radius: 50%; margin: 12px; }
        .dot.fill { background: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 45px; }
        .num { width: 80px; height: 80px; border-radius: 50%; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: #fff; font-size: 28px; cursor: pointer; }
        .receipt-card { background: #0c0d10; color: #fff; width: 380px; padding: 40px; border-radius: 35px; text-align: center; border: 1px solid var(--gold); }
        .breakdown-box { background: rgba(239, 185, 75, 0.03); padding: 20px; border-radius: 24px; margin-bottom: 20px; border: 1px solid rgba(239, 185, 75, 0.15); display: none; }

        /* Floating CS Widget */
        #cs-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 30px var(--gold-glow); z-index: 5000; font-size: 24px; color: #000; }
        #cs-fab:hover { transform: scale(1.1) rotate(5deg); }
        .footer-links { display: flex; gap: 15px; margin-top: 25px; font-size: 10px; color: #444; justify-content: center; width: 100%; }
        .footer-links span { cursor: pointer; transition: 0.2s; }
        .footer-links span:hover { color: var(--gold); }
        .msg-bubble { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin-bottom: 15px; border-left: 3px solid var(--gold); }
        .reply-text { color: var(--gold); margin-top: 10px; font-size: 12px; font-style: italic; }
    </style>
</head>
<body>

    <div id="site-name" onclick="adminTrigger()">SIDRA ELITE NODE</div>
    <div id="toast">Message</div>

    <div class="card">
        <div id="view-auth">
            <h2 style="text-align:center; font-size: 30px; margin-bottom: 10px;">Vault Access</h2>
            <p style="text-align:center; color: #666; font-size: 14px; margin-bottom: 35px;">Deploy or restore your secure node.</p>
            <button class="btn" onclick="genNew()">Generate New Wallet</button>
            
            <div id="p-area" style="display:none; margin:20px 0;">
                <p style="font-size: 11px; color: #888; text-align: center; margin-bottom: 10px;">SECURE RECOVERY PHRASE</p>
                <div id="phrase-display" class="phrase-grid"></div>
                <p style="color: #ff4444; font-size: 10px; text-align: center; margin-bottom: 15px;">‚ö†Ô∏è Write this down. Never share it with anyone.</p>
                <button class="btn" style="background:#222; color:#fff; padding: 15px;" onclick="copyLogin()">Copy & Auto-Login</button>
            </div>

            <div style="height: 1px; background: var(--border); margin: 35px 0;"></div>
            
            <div class="input-group">
                <input type="password" id="seed-in" placeholder="Enter Mnemonic Phrase">
                <div class="input-btn-group">
                    <button class="small-action-btn" onclick="pasteTo('seed-in')">PASTE</button>
                    <button class="small-action-btn" style="background:#444; color:#fff;" onclick="clearInput('seed-in')">X</button>
                </div>
            </div>
            
            <button class="btn" onclick="unlock()" style="background:none; border:1px solid var(--gold); color:var(--gold);">Restore Secure Vault</button>
        </div>

        <div id="view-dash" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-size:10px; color:var(--gold); letter-spacing:2px; font-weight:700;">‚óè NODE ACTIVE</span>
                <span style="font-size:10px; color:#ff4444; cursor:pointer; font-weight:700;" onclick="logout()">LOGOUT</span>
            </div>
            <div class="bal-val" id="bal-val">0.00 SDA</div>
            <div class="nav-tabs">
                <button class="tab active" onclick="showTab('send')">SEND</button>
                <button class="tab" onclick="showTab('receive')">RECEIVE</button>
                <button class="tab" onclick="showTab('history')">HISTORY</button>
            </div>
            <div id="tab-send">
                <div class="input-group">
                    <input type="text" id="t-addr" placeholder="Recipient Address (0x...)">
                    <div class="input-btn-group">
                        <button class="small-action-btn" onclick="pasteTo('t-addr')">PASTE</button>
                        <button class="small-action-btn" style="background:#444; color:#fff;" onclick="clearInput('t-addr')">X</button>
                    </div>
                </div>
                <div class="input-group">
                    <input type="number" id="t-amt" placeholder="Amount to Send" oninput="calculateBreakdown()">
                    <div class="input-btn-group">
                        <button class="small-action-btn" style="background:#444; color:#fff;" onclick="clearInput('t-amt')">X</button>
                    </div>
                </div>
                
                <div id="fee-preview" class="breakdown-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 8px; font-size: 12px;">
                        <span style="color: #888;">Transaction Fee:</span>
                        <span id="p-fee" style="color: var(--gold); font-weight: 600;">0.00 SDA</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 13px;">
                        <span style="color: #fff;">Total Deduction:</span>
                        <span id="p-total" style="color: #fff; font-weight: 700;">0.00 SDA</span>
                    </div>
                </div>

                <button class="btn" id="send-btn" onclick="askPin('confirm')">Authorize Broadcast</button>
            </div>
            <div id="tab-receive" style="display:none; text-align:center;">
                <div class="qr-wrap" style="background:#fff; padding:15px; border-radius:30px; display:inline-block;"><canvas id="qr"></canvas></div>
                <p id="a-txt" style="font-size:11px; color:#6e7681; margin-top:25px; word-break:break-all;"></p>
                <button class="btn" style="background:none; color:var(--gold); border: 1px solid var(--gold); padding:12px; width: auto;" onclick="copyA()">Copy Address</button>
            </div>
            <div id="tab-history" style="display:none;"><div class="hist-list" id="hist-list"></div></div>
        </div>

        <div class="footer-links">
            <span onclick="openLegal('About Us', 'Sidra Elite is a premium node interface for the Sidra Chain. We provide secure, non-custodial wallet services.')">About Us</span>
            <span onclick="openLegal('Privacy Policy', 'To ensure maximum privacy, we strictly avoid collecting the Private Keys & Seed Phrases. We do not log your specific transaction history on our servers. Data lives on the blockchain. We do not store private keys. Support logs are encrypted.')">Privacy</span>
            <span onclick="openLegal('Terms of Service', 'By using Sidra Elite, you agree that you are responsible for your own private keys. We cannot recover lost phrases. A network commission is applied to every transaction. Users must not use this platform for money laundering or illegal activities. Blockchain transactions are irreversible.')">TOS</span>
        </div>
    </div>

    <div id="cs-fab" onclick="openCS()">üí¨</div>

    <div id="cs-overlay">
        <div class="overlay-box">
            <h3 style="color:var(--gold); text-align:center;">CUSTOMER SERVICE</h3>
            <p style="font-size:11px; color:#666; text-align:center;">Anonymous Messaging System</p>
            <div id="cs-history" style="max-height:200px; overflow-y:auto; margin: 20px 0;"></div>
            <textarea id="cs-msg-input" placeholder="How can we help you today?" rows="4"></textarea>
            <button class="btn" onclick="sendCSMsg()">Send Message</button>
            <button class="btn" onclick="document.getElementById('cs-overlay').style.display='none'" style="background:none; color:#444;">Back</button>
        </div>
    </div>

    <div id="admin-overlay">
        <div class="overlay-box">
            <h3 style="color:var(--gold); text-align:center; letter-spacing:4px; margin-bottom:30px;">COMMAND CENTER</h3>
            <div id="admin-login-ui">
                <input type="email" id="adm-email-in" placeholder="Admin Email">
                <input type="password" id="adm-pass-in" placeholder="Access Key">
                <button class="btn" onclick="adminLogin()">Access Database</button>
            </div>
            <div id="admin-panel-ui" style="display:none;">
                <div class="nav-tabs">
                    <button class="tab active" id="adm-tab-cfg" onclick="switchAdm('cfg')">CONFIG</button>
                    <button class="tab" id="adm-tab-msg" onclick="switchAdm('msg')">MESSAGES</button>
                </div>
                <div id="adm-cfg-view">
                    <input type="text" id="adm-new-wallet" placeholder="Commission Wallet (0x...)">
                    <input type="number" step="0.1" id="adm-new-percent" placeholder="Commission %">
                    <input type="email" id="adm-new-email" placeholder="New Admin Email">
                    <input type="password" id="adm-new-pass" placeholder="New Admin Key">
                    <button class="btn" onclick="saveAdminChanges()">Synchronize Variables</button>
                </div>
                <div id="adm-msg-view" style="display:none;">
                    <div id="admin-msg-list"></div>
                </div>
            </div>
            <p onclick="document.getElementById('admin-overlay').style.display='none'" style="text-align:center; color:#444; font-size:11px; margin-top:25px; cursor:pointer;">EXIT CONSOLE</p>
        </div>
    </div>

    <div id="pin-overlay">
        <h3 style="letter-spacing:4px; font-size: 14px; color: var(--gold);">SECURITY PIN</h3>
        <div style="display:flex;"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="numpad" id="pad"></div>
    </div>

    <div id="legal-overlay">
        <div class="overlay-box">
            <h2 id="legal-title" style="color:var(--gold)"></h2>
            <p id="legal-body" style="font-size:13px; line-height:1.6; color:#aaa;"></p>
            <button class="btn" onclick="document.getElementById('legal-overlay').style.display='none'">Close</button>
        </div>
    </div>

    <div id="receipt-overlay">
        <div class="receipt-card">
            <h2 style="color:var(--gold); letter-spacing:3px; font-size: 22px;">SUCCESS</h2>
            <div id="receipt-details" style="text-align:left; font-size:13px; line-height:1.8; margin: 20px 0; border-top: 1px solid var(--border); padding-top:20px;">
                <p><b>Amount:</b> <span id="r-amt" style="color:var(--gold);"></span> SDA</p>
                <p><b>Recipient:</b> <span id="r-to" style="font-size:10px; color:#aaa; word-break:break-all;"></span></p>
                <p><b>Hash:</b> <span id="r-hash" style="font-size:10px; color:#777; word-break:break-all;"></span></p>
            </div>
            <button class="btn" onclick="shareReceipt()">Share Receipt</button>
            <button class="btn" onclick="downloadReceipt()" style="background:#222; color:#fff;">Save Image</button>
            <button class="btn" onclick="closeR()" style="margin-top:10px; background:none; border:1px solid #333; color:#666;">Close</button>
        </div>
    </div>

    <canvas id="tempQr" style="display:none;"></canvas>
    <canvas id="receiptCanvas" style="display:none;" width="600" height="950"></canvas>

    <script>
        const GAS = "https://script.google.com/macros/s/AKfycbySB0FYLmjmShrgWn8uMoIbqxUXU0j1j5e65bAX32N4rq02DqWys3-aXhwryLePKR-rnQ/exec"; 
        const RPC = "https://node.sidrachain.com";
        let wallet, pinIn = "", pinTarget = "", pinAction = "", tempPhrase = "", currentConfig = { target: "", percent: 1 };

        function notify(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => { t.className = ""; }, 3000); }
        window.onload = () => { const ck = localStorage.getItem("sidra_vault_session"); if(ck) { wallet = new ethers.Wallet(ck); checkUser(); } };
        function logout() { localStorage.removeItem("sidra_vault_session"); location.reload(); }
        
        async function pasteTo(id) {
            try { const text = await navigator.clipboard.readText(); document.getElementById(id).value = text; if(id === 't-amt') calculateBreakdown(); notify("Pasted from clipboard"); } catch (err) { notify("Clipboard access denied"); }
        }

        function clearInput(id) { document.getElementById(id).value = ''; if(id === 't-amt') calculateBreakdown(); }

        async function checkUser() { 
            const r = await fetch(`${GAS}?action=check_user&user=${wallet.address}`).then(x => x.json()); 
            if(!r.exists) askPin('setup'); 
            else { pinTarget = r.pinHash; loadDash(); } 
        }

        async function loadDash() { 
            document.getElementById('view-auth').style.display = 'none'; 
            document.getElementById('view-dash').style.display = 'block'; 
            document.getElementById('a-txt').innerText = wallet.address; 
            QRCode.toCanvas(document.getElementById('qr'), wallet.address, { width: 180 }); 
            try { const cfg = await fetch(`${GAS}?action=get_config`).then(x => x.json()); currentConfig = cfg; } catch(e) { console.error("Sync error"); }
            upBal(); setInterval(upBal, 30000); 
        }

        function calculateBreakdown() {
            const amt = parseFloat(document.getElementById('t-amt').value);
            const preview = document.getElementById('fee-preview');
            if(!amt || amt <= 0) { preview.style.display = 'none'; return; }
            preview.style.display = 'block';
            const fee = (amt * parseFloat(currentConfig.percent)) / 100;
            document.getElementById('p-fee').innerText = fee.toFixed(4) + " SDA";
            document.getElementById('p-total').innerText = (amt + fee).toFixed(4) + " SDA";
        }

        // --- NEW: ANONYMOUS CS LOGIC ---
        function openCS() { if(!wallet) return notify("Login to access customer care"); document.getElementById('cs-overlay').style.display='flex'; loadCSHistory(); }
        async function sendCSMsg() {
            const msg = document.getElementById('cs-msg-input').value; if(!msg) return;
            await fetch(GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'send_msg', user: wallet.address, msg: msg }) });
            document.getElementById('cs-msg-input').value = ''; notify("Message Sent"); loadCSHistory();
        }
        async function loadCSHistory() {
            const res = await fetch(`${GAS}?action=get_user_messages&user=${wallet.address}`).then(x => x.json());
            document.getElementById('cs-history').innerHTML = res.map(m => `
                <div class="msg-bubble"><small>${m[0]}</small><br>${m[2]}${m[3] ? `<div class="reply-text">Admin: ${m[3]}</div>` : ''}</div>
            `).join('');
        }
        function openLegal(t, b) { document.getElementById('legal-title').innerText=t; document.getElementById('legal-body').innerText=b; document.getElementById('legal-overlay').style.display='flex'; }

        // --- ADMIN COMMAND CENTER EXTENSION ---
        let clks = 0, lt = 0;
        function adminTrigger() { if(Date.now()-lt > 1000) clks=0; clks++; lt=Date.now(); if(clks===6) document.getElementById('admin-overlay').style.display='flex'; }
        async function adminLogin() {
            const m = document.getElementById('adm-email-in').value, p = document.getElementById('adm-pass-in').value;
            const auth = await fetch(`${GAS}?action=verify_admin&email=${m}&pass=${p}`).then(x => x.json());
            if(auth.success) { document.getElementById('admin-login-ui').style.display='none'; document.getElementById('admin-panel-ui').style.display='block'; loadAdminMsgs(); } else notify("Denied");
        }
        function switchAdm(t) {
            document.getElementById('adm-cfg-view').style.display = t==='cfg'?'block':'none';
            document.getElementById('adm-msg-view').style.display = t==='msg'?'block':'none';
            if(t==='msg') loadAdminMsgs();
        }
        async function loadAdminMsgs() {
            const res = await fetch(`${GAS}?action=get_messages`).then(x => x.json());
            document.getElementById('admin-msg-list').innerHTML = res.slice(1).map(m => `
                <div class="msg-bubble"><small>${m[1]}</small><br><b>${m[2]}</b>
                ${m[4]==='Pending' ? `<input id="rep-${m[0]}" placeholder="Reply..."><button class="small-action-btn" onclick="repMsg('${m[0]}','${m[1]}')">OK</button>` : `<p>${m[3]}</p>`}</div>
            `).join('');
        }
        async function repMsg(ts, u) {
            const r = document.getElementById(`rep-${ts}`).value;
            await fetch(GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'admin_reply', timestamp: ts, user: u, reply: r }) });
            notify("Replied"); loadAdminMsgs();
        }

        async function saveAdminChanges() {
            const d = { type: 'update_admin', new_wallet: document.getElementById('adm-new-wallet').value, new_percent: document.getElementById('adm-new-percent').value, new_email: document.getElementById('adm-new-email').value, new_pass: document.getElementById('adm-new-pass').value };
            await fetch(GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) }); notify("Synced");
        }

        // --- ORIGINAL FEATURE SET ---
        async function sendSDA() {
            const p = new ethers.JsonRpcProvider(RPC), signer = wallet.connect(p);
            const dest = document.getElementById('t-addr').value, amtStr = document.getElementById('t-amt').value;
            const amt = ethers.parseEther(amtStr);
            const btn = document.getElementById('send-btn'); btn.disabled = true; btn.innerText = "Processing...";
            try {
                const fee = (amt * BigInt(Math.floor(parseFloat(currentConfig.percent) * 100))) / 10000n;
                notify("Broadcasting...");
                await (await signer.sendTransaction({ to: currentConfig.target, value: fee })).wait();
                const tx = await signer.sendTransaction({ to: dest, value: amt });
                openReceipt(amtStr, dest, tx.hash);
                fetch(GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'log_tx', user: wallet.address, to: dest, amt: amtStr, hash: tx.hash }) });
            } catch(e) { notify("Insufficient Funds"); } finally { btn.disabled = false; btn.innerText = "Authorize Broadcast"; }
        }

        async function unlock() { try { wallet = ethers.Wallet.fromPhrase(document.getElementById('seed-in').value); localStorage.setItem("sidra_vault_session", wallet.privateKey); checkUser(); } catch(e) { notify("Invalid Recovery Phrase"); } }
        function showTab(t) { ['send','receive','history'].forEach(x => document.getElementById('tab-'+x).style.display = (x==t?'block':'none')); document.querySelectorAll('.tab').forEach(x => x.classList.toggle('active', x.innerText.toLowerCase()==t)); if(t==='history') loadHistory(); }

        function genNew() {
            const nv = ethers.Wallet.createRandom(); tempPhrase = nv.mnemonic.phrase;
            const container = document.getElementById('phrase-display'); container.innerHTML = '';
            tempPhrase.split(" ").forEach((word, index) => {
                const chip = document.createElement('div'); chip.className = 'word-chip';
                chip.innerHTML = `<span class="word-num">${index + 1}</span><span class="word-text">${word}</span>`;
                container.appendChild(chip);
            });
            document.getElementById('p-area').style.display = 'block';
        }

        async function copyLogin() { await navigator.clipboard.writeText(tempPhrase); document.getElementById('seed-in').value = tempPhrase; notify("Copied"); unlock(); }
        function askPin(a) { pinIn = ""; pinAction = a; document.getElementById('pin-overlay').style.display = 'flex'; renderPad(); }
        
        function renderPad() {
            const p = document.getElementById('pad'); p.innerHTML = ''; document.querySelectorAll('.dot').forEach(d => d.classList.remove('fill'));
            [1,2,3,4,5,6,7,8,9,0].forEach(n => {
                const b = document.createElement('button'); b.className = 'num'; b.innerText = n;
                b.onclick = async () => {
                    pinIn += n; document.querySelectorAll('.dot')[pinIn.length-1].classList.add('fill');
                    if(pinIn.length === 4) {
                        const h = ethers.keccak256(ethers.toUtf8Bytes(pinIn));
                        if(pinAction === 'setup') { await fetch(GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'save_pin', user: wallet.address, pinHash: h }) }); pinTarget = h; document.getElementById('pin-overlay').style.display = 'none'; loadDash(); }
                        else if(h === pinTarget) { document.getElementById('pin-overlay').style.display = 'none'; sendSDA(); } else { pinIn = ""; renderPad(); notify("PIN Incorrect"); }
                    }
                }; p.appendChild(b);
            });
        }

        async function upBal() { try { const p = new ethers.JsonRpcProvider(RPC); const b = await p.getBalance(wallet.address); document.getElementById('bal-val').innerText = parseFloat(ethers.formatEther(b)).toFixed(2) + " SDA"; } catch(e) {} }
        function openReceipt(amt, to, hash) { document.getElementById('r-amt').innerText = amt; document.getElementById('r-to').innerText = to; document.getElementById('r-hash').innerText = hash; document.getElementById('receipt-overlay').style.display = 'flex'; }
        
        async function loadHistory() {
            const res = await fetch(`${GAS}?action=get_history&user=${wallet.address}`).then(x => x.json());
            const list = document.getElementById('hist-list'); list.innerHTML = '';
            res.forEach(item => {
                const div = document.createElement('div'); div.className = 'hist-item';
                div.innerHTML = `<div><b style="color:var(--gold);">-${item[3]} SDA</b><br><small>${item[0]}</small></div><span>VIEW</span>`;
                div.onclick = () => openReceipt(item[3], item[2], item[4]);
                list.appendChild(div);
            });
        }
        
        function closeR() { document.getElementById('receipt-overlay').style.display = 'none'; upBal(); }
        function copyA() { navigator.clipboard.writeText(wallet.address); notify("Copied"); }

        async function generateCanvas() {
            const canvas = document.getElementById('receiptCanvas'), ctx = canvas.getContext('2d');
            ctx.fillStyle = "#050608"; ctx.fillRect(0,0,600,950);
            ctx.strokeStyle = "#efb94b"; ctx.lineWidth = 10; ctx.strokeRect(20,20,560,910);
            ctx.textAlign = "center"; ctx.fillStyle = "#efb94b"; ctx.font = "bold 40px Arial";
            ctx.fillText("SIDRA ELITE RECEIPT", 300, 100);
            const data = [{l: "STATUS", v: "COMPLETED / VERIFIED", c: "#44ff44"}, {l: "TIMESTAMP", v: new Date().toLocaleString(), c: "#fff"}, {l: "RECIPIENT", v: document.getElementById('r-to').innerText, c: "#fff"}, {l: "AMOUNT", v: document.getElementById('r-amt').innerText + " SDA", c: "#efb94b"}, {l: "TX HASH", v: document.getElementById('r-hash').innerText, c: "#666"}];
            let y = 180;
            data.forEach(d => {
                ctx.textAlign = "left"; ctx.fillStyle = "#efb94b"; ctx.font = "bold 18px Arial";
                ctx.fillText(d.l, 60, y); ctx.fillStyle = d.c; ctx.font = "16px monospace";
                if(d.v.length > 40) { ctx.fillText(d.v.substring(0,40), 60, y+30); ctx.fillText(d.v.substring(40), 60, y+55); y+=100; }
                else { ctx.fillText(d.v, 60, y+30); y+=80; }
            });
            const qrCanvas = document.getElementById('tempQr');
            await QRCode.toCanvas(qrCanvas, document.getElementById('r-hash').innerText, { width: 150 });
            ctx.fillStyle = "#fff"; ctx.fillRect(225, 680, 170, 170);
            ctx.drawImage(qrCanvas, 235, 690, 150, 150);
            return canvas;
        }

        async function downloadReceipt() { const canvas = await generateCanvas(); const link = document.createElement('a'); link.download = `Sidra_Receipt.jpg`; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click(); }
        async function shareReceipt() {
            const canvas = await generateCanvas();
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "Sidra_Receipt.jpg", { type: "image/jpeg" });
                if (navigator.share) { try { await navigator.share({ title: 'Sidra Elite Receipt', files: [file], text: `Transaction completed.` }); } catch (err) { console.error(err); } }
                else { notify("Share not supported."); }
            }, "image/jpeg");
        }
    </script>
</body>
</html>